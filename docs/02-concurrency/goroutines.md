# Goroutines Deep Dive

Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° â€” Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ° ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² Go. Ğ­Ñ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ¸ Ğ½Ğµ ĞºĞ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ² ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğ¸ â€” ÑÑ‚Ğ¾ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ñ Go runtime.

::: tip Ğ¡Ğ²ÑĞ·ÑŒ Ñ GMP Scheduler
Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° `runtime.g` Ğ¸ ĞµÑ‘ ÑĞ²ÑĞ·ÑŒ Ñ M Ğ¸ P Ñ€Ğ°ÑÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ñ‹ Ğ² Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğµ [GMP Scheduler](/01-runtime/gmp-scheduler). Ğ—Ğ´ĞµÑÑŒ Ñ„Ğ¾ĞºÑƒÑ Ğ½Ğ° **Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ğ¾Ğ¼ Ñ†Ğ¸ĞºĞ»Ğµ**, **ÑÑ‚ĞµĞºĞµ** Ğ¸ **preemption**.
:::

## Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Goroutine

### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: runtime.newproc

ĞšĞ¾Ğ³Ğ´Ğ° Ğ²Ñ‹ Ğ¿Ğ¸ÑˆĞµÑ‚Ğµ `go func()`, ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ² `runtime.newproc`:

```go
// ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚:
go myFunc(arg1, arg2)

// Ğ’:
runtime.newproc(funcval, arg1, arg2)
```

Ğ’Ğ½ÑƒÑ‚Ñ€Ğ¸ `newproc`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          runtime.newproc                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ P                                                      â”‚
â”‚     gp := getg()                                                            â”‚
â”‚     _p_ := gp.m.p.ptr()                                                     â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ G Ğ¸Ğ· ĞºÑÑˆĞ° Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  if _p_.gFree.empty() {                                         â”‚     â”‚
â”‚     â”‚      // ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ·ÑÑ‚ÑŒ Ğ¸Ğ· Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºÑÑˆĞ°                   â”‚     â”‚
â”‚     â”‚      if !sched.gFree.stack.empty() || !sched.gFree.noStack...   â”‚     â”‚
â”‚     â”‚  } else {                                                       â”‚     â”‚
â”‚     â”‚      newg = _p_.gFree.pop()  // Ğ’Ğ·ÑÑ‚ÑŒ Ğ¸Ğ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºÑÑˆĞ° P      â”‚     â”‚
â”‚     â”‚  }                                                              â”‚     â”‚
â”‚     â”‚  if newg == nil {                                               â”‚     â”‚
â”‚     â”‚      newg = malg(_StackMin)   // ĞĞ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ G              â”‚     â”‚
â”‚     â”‚  }                                                              â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  3. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ĞµĞº Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚                                        â”‚
â”‚     newg.sched.sp = sp                                                      â”‚
â”‚     newg.sched.pc = goexit + 1  // Return address â†’ goexit                  â”‚
â”‚     newg.sched.g = guintptr(unsafe.Pointer(newg))                           â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  4. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ _Grunnable                                            â”‚
â”‚     casgstatus(newg, _Gdead, _Grunnable)                                    â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  5. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ P                                                    â”‚
â”‚     runqput(_p_, newg, true)  // true = Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸Ğ´Ñ‚Ğ¸ Ğ² runnext                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚ĞµĞº: _StackMin

```go
// runtime/stack.go
const _StackMin = 2048  // 2KB Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚ĞµĞº

// malg ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ G Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ¼ ÑÑ‚ĞµĞºĞ°
func malg(stacksize int32) *g {
    newg := new(g)
    if stacksize >= 0 {
        stacksize = round2(_StackSystem + stacksize)
        newg.stack = stackalloc(uint32(stacksize))
        newg.stackguard0 = newg.stack.lo + _StackGuard
        newg.stackguard1 = ^uintptr(0)  // Ğ”Ğ»Ñ C stack
    }
    return newg
}
```

## Ğ’ÑĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Goroutine

Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ‡ĞµÑ€ĞµĞ· 10 Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹:

<InteractiveModal title="Goroutine Lifecycle" icon="ğŸ”„" description="Ğ¡Ğ¸Ğ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ° Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹">
  <GoroutineLifecycleSimulator />
</InteractiveModal>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Goroutine State Machine                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                              â”‚  _Gidle  â”‚ 0 - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°                â”‚
â”‚                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                   â”‚ malg()                                  â”‚
â”‚                                   â–¼                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                         â”Œâ”€â”€â”€â–¶â”‚  _Gdead  â”‚ 6 - Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ               â”‚
â”‚                         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                         â”‚         â”‚ newproc()                               â”‚
â”‚              goexit()   â”‚         â–¼                                         â”‚
â”‚                         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                         â””â”€â”€â”€â”€â”‚ _Grunnable   â”‚ 1 - Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ½Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ   â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                     â”‚ execute()                             â”‚
â”‚                                     â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚_Gwaiting   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  _Grunning   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ _Gsyscall  â”‚    â”‚
â”‚  â”‚ 4 - blockedâ”‚  gopark()   â”‚ 2 - running  â”‚  entersyscallâ”‚ 3 - syscallâ”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                           â”‚                            â”‚           â”‚
â”‚        â”‚ goready()                 â”‚ Gosched()         exitsyscall()        â”‚
â”‚        â”‚                           â”‚                            â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚                              back to _Grunnable                             â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ _Gcopystack â”‚  â”‚ _Gpreempted  â”‚  â”‚ _Gscan...    â”‚  â”‚ _Gmoribund_   â”‚     â”‚
â”‚  â”‚ 8 - ĞºĞ¾Ğ¿Ğ¸Ñ€Ñƒ- â”‚  â”‚ 9 - preempt  â”‚  â”‚ 0x1000+ scan â”‚  â”‚ unused (7)    â”‚     â”‚
â”‚  â”‚ ĞµĞ¼ ÑÑ‚ĞµĞº     â”‚  â”‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°  â”‚  â”‚ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”‚  â”‚               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹

```go
// runtime/runtime2.go
const (
    _Gidle    = iota // 0 - G ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°, Ğ½Ğ¾ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°
    _Grunnable       // 1 - Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸, Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
    _Grunning        // 2 - Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ½Ğ° M
    _Gsyscall        // 3 - Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ syscall
    _Gwaiting        // 4 - Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° (channel, mutex, etc.)
    _Gmoribund_unused
    _Gdead           // 6 - Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ°
    _Genqueue_unused
    _Gcopystack      // 8 - ÑÑ‚ĞµĞº ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ (stack growth)
    _Gpreempted      // 9 - preempted, Ğ¶Ğ´Ñ‘Ñ‚ reschedule

    _Gscan          = 0x1000  // ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ğ´Ğ»Ñ GC scan
    _Gscanrunnable  = _Gscan + _Grunnable
    _Gscanrunning   = _Gscan + _Grunning
    // ...
)
```

### ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑĞ¼Ğ¸

| ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ | Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ | ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ |
|---------|---------|------------------|
| `_Gdead` â†’ `_Grunnable` | `newproc` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ |
| `_Grunnable` â†’ `_Grunning` | `execute` | Scheduler Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» G |
| `_Grunning` â†’ `_Gwaiting` | `gopark` | Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° channel/mutex |
| `_Gwaiting` â†’ `_Grunnable` | `goready` | Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° |
| `_Grunning` â†’ `_Gsyscall` | `entersyscall` | Ğ’Ñ…Ğ¾Ğ´ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² |
| `_Gsyscall` â†’ `_Grunnable` | `exitsyscall` | Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¸Ğ· syscall |
| `_Grunning` â†’ `_Gdead` | `goexit` | Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ |
| `_Grunning` â†’ `_Gcopystack` | `copystack` | Ğ Ğ¾ÑÑ‚ ÑÑ‚ĞµĞºĞ° |
| `_Grunning` â†’ `_Gpreempted` | async preemption | SIGURG signal |

## Stack Growth: ĞšĞ°Ğº ÑÑ‚ĞµĞº Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚

Go Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **contiguous stacks** â€” ÑÑ‚ĞµĞº Ğ²ÑĞµĞ³Ğ´Ğ° Ğ½ĞµĞ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸. ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğ¹, Ğ±Ğ¾ÌĞ»ÑŒÑˆĞ¸Ğ¹ ÑÑ‚ĞµĞº, Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒÑÑ‚ÑÑ.

### Stack Check: Preamble ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ°

ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ ÑÑ‚ĞµĞºĞ° Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:

```asm
; ĞŸÑ€Ğ¾Ğ»Ğ¾Ğ³ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ ÑÑ‚ĞµĞºĞ°
TEXT Â·myFunction(SB), NOSPLIT, $64-16
    MOVQ    (TLS), CX           ; CX = Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ g
    LEAQ    -64(SP), AX         ; AX = SP - framesize
    CMPQ    AX, 16(CX)          ; Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ñ g.stackguard0
    JBE     morestack           ; Ğ•ÑĞ»Ğ¸ Ğ¼ĞµĞ½ÑŒÑˆĞµ â†’ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑÑ‚ĞµĞºĞ°
    ; ... Ñ‚ĞµĞ»Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ...

morestack:
    CALL    runtimeÂ·morestack(SB)
    JMP     myFunction(SB)      ; Retry Ğ¿Ğ¾ÑĞ»Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ ÑÑ‚ĞµĞºĞ°
```

### runtime.morestack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Stack Growth Process                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. morestack_noctxt Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ                                             â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ² g.sched (SP, PC, ctxt)                             â”‚
â”‚     gp.sched.sp = sp                                                        â”‚
â”‚     gp.sched.pc = pc                                                        â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  3. ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° g0 stack (ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ ÑÑ‚ĞµĞº M)                            â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  4. newstack() Ğ½Ğ° g0                                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº (2KB)          ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚ĞµĞº (4KB)                     â”‚     â”‚
â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚     â”‚ â”‚ frame N       â”‚          â”‚                               â”‚    â”‚     â”‚
â”‚     â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   copy   â”‚                               â”‚    â”‚     â”‚
â”‚     â”‚ â”‚ frame N-1     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ frame N (adjusted pointers)   â”‚    â”‚     â”‚
â”‚     â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚     â”‚
â”‚     â”‚ â”‚ frame N-2     â”‚          â”‚ frame N-1                     â”‚    â”‚     â”‚
â”‚     â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚     â”‚
â”‚     â”‚ â”‚ ...           â”‚          â”‚ frame N-2                     â”‚    â”‚     â”‚
â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚     â”‚
â”‚     â”‚                            â”‚ ...                           â”‚    â”‚     â”‚
â”‚     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚     â”‚
â”‚     â”‚                            â”‚         FREE SPACE            â”‚    â”‚     â”‚
â”‚     â”‚                            â”‚                               â”‚    â”‚     â”‚
â”‚     â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  5. Pointer Adjustment                                                      â”‚
â”‚     â€¢ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğ° ÑÑ‚ĞµĞº Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ÑÑ‚ĞµĞºĞ°                           â”‚
â”‚     â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ stack map Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ°                                 â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  6. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ g.stack, g.stackguard0                                         â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  7. ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº                                                  â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  8. gogo(&gp.sched) â€” Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### copystack: ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ fixup

```go
// runtime/stack.go
func copystack(gp *g, newsize uintptr) {
    old := gp.stack
    // used â€” ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ±Ğ°Ğ¹Ñ‚, Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ñ… Ğ½Ğ° ÑÑ‚ĞµĞºĞµ
    // old.hi â€” Ğ²ĞµÑ€Ñ…Ğ½ÑÑ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ÑÑ‚ĞµĞºĞ° (ÑÑ‚ĞµĞº Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ Ğ²Ğ½Ğ¸Ğ·!)
    // gp.sched.sp â€” Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ stack pointer
    used := old.hi - gp.sched.sp

    // 1. ĞĞ»Ğ»Ğ¾Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚ĞµĞº Ğ¸Ğ· span cache
    //    stackalloc Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ size classes: 2KB, 4KB, 8KB, 16KB...
    //    Ğ”Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… ÑÑ‚ĞµĞºĞ¾Ğ² (>32KB) Ğ²Ñ‹Ğ´ĞµĞ»ÑĞµÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¸Ğ· heap
    new := stackalloc(uint32(newsize))

    // 2. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ delta Ğ´Ğ»Ñ pointer adjustment
    //    Ğ’ÑĞµ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ´Ğ²Ğ¸Ğ½ÑƒÑ‚ÑŒ Ğ½Ğ° ÑÑ‚Ñƒ Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ½Ñƒ
    //    delta Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ° ĞµÑĞ»Ğ¸ ÑÑ‚ĞµĞº Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚, Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ° ĞµÑĞ»Ğ¸ ÑĞ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ
    delta := new.hi - old.hi

    // 3. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑÑ‚ĞµĞºĞ°
    //    ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ SP Ğ´Ğ¾ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    //    Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ¸Ğ¶Ğµ SP â€” Ğ¼ÑƒÑĞ¾Ñ€, Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
    memmove(unsafe.Pointer(new.hi-used),
            unsafe.Pointer(old.hi-used),
            used)

    // 4. ĞŸÑ€Ğ¾Ğ¹Ñ‚Ğ¸ÑÑŒ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ½Ğ° ÑÑ‚ĞµĞº Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ñ…
    //    adjustpointers Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ stack maps Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ°
    //    Stack map ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ bitmap: ĞºĞ°ĞºĞ¸Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ² frame â€” ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸
    //    Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ frame Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ adjustframe()
    adjustpointers(...)

    // 5. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ defer frames
    //    defer Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° frame â€” Ğ¸Ñ… Ñ‚Ğ¾Ğ¶Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
    adjustdefers(gp, delta)

    // 6. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ panic frames
    //    panic Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ stack pointers
    adjustpanics(gp, delta)

    // 7. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ g
    gp.stack = new
    gp.stackguard0 = new.lo + _StackGuard  // ĞĞ¾Ğ²Ğ°Ñ guard zone
    gp.sched.sp += delta                    // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ saved SP

    // 8. ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº
    //    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ² span cache Ğ¸Ğ»Ğ¸ heap
    stackfree(old)
}
```

### Pointer Adjustment Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ

```go
// adjustframe Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ stack frame
func adjustframe(frame *stkframe, arg unsafe.Pointer) bool {
    adjinfo := (*adjustinfo)(arg)

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ stack map Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ PC
    // Stack map Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ¸ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² PCDATA
    locals, args := getStackMap(frame)

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
    adjustpointers(unsafe.Pointer(frame.varp-size), &locals, adjinfo)

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ² Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ…
    adjustpointers(unsafe.Pointer(frame.argp), &args, adjinfo)

    return true  // ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ…Ğ¾Ğ´ frames
}

// adjustpointers Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ bitmap
func adjustpointers(scanp unsafe.Pointer, bv *bitvector, adjinfo *adjustinfo) {
    delta := adjinfo.delta
    for i := uintptr(0); i < bv.n; i++ {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑĞ»Ğ¾Ğ²Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¼ (Ğ¿Ğ¾ bitmap)
        if bv.ptrbit(i) {
            pp := (*uintptr)(add(scanp, i*goarch.PtrSize))
            p := *pp

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ»Ğ¸ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº
            if adjinfo.old.lo <= p && p < adjinfo.old.hi {
                // Ğ¡Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° delta
                *pp = p + delta
            }
        }
    }
}
```

### Stack Shrinking

Ğ¡Ñ‚ĞµĞº ÑĞ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ GC, ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¼ĞµĞ½ĞµĞµ 1/4. Ğ­Ñ‚Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ â€” Ğ±ĞµĞ· Ğ½ĞµÑ‘ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ ÑÑ‚ĞµĞºĞ°, Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±Ñ‹ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ ÑÑ‚Ñƒ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ.

```go
// runtime/stack.go (ÑƒĞ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ¾)
func shrinkstack(gp *g) {
    // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· scanstack() Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ GC mark phase
    // Ğ’ĞĞ–ĞĞ: Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° (Ğ½Ğµ _Grunning)

    // Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ÑÑ‚ĞµĞºĞ°
    oldsize := gp.stack.hi - gp.stack.lo
    // Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ â€” Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ğ¸Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾
    newsize := oldsize / 2

    // ĞĞµ ÑĞ¶Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼Ğ° (2KB Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)
    // _FixedStack = _StackMin Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½
    if newsize < _FixedStack {
        return
    }

    // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ ÑÑ‚ĞµĞº
    // gp.sched.sp â€” ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ stack pointer Ğ¿Ñ€Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ
    used := gp.stack.hi - gp.sched.sp

    // ĞŸĞ¾Ñ€Ğ¾Ğ³: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¼ĞµĞ½ÑŒÑˆĞµ 1/4 Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°
    // ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ 1/4, Ğ° Ğ½Ğµ 1/2?
    // - Ğ“Ğ¸ÑÑ‚ĞµÑ€ĞµĞ·Ğ¸Ñ: Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ thrashing (grow â†’ shrink â†’ grow)
    // - ĞŸĞ¾ÑĞ»Ğµ shrink Ğ½Ğ° 1/2, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ ~1/2 Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°
    // - ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ğ°Ñ Ğ´Ğ»Ñ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ³Ğ¾ Ñ€Ğ¾ÑÑ‚Ğ° Ğ±ĞµĞ· reallocation
    if used >= oldsize/4 {
        return  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 1/4 â€” Ğ½Ğµ ÑĞ¶Ğ¸Ğ¼Ğ°Ñ‚ÑŒ
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ»Ğ¸ ÑĞ¶Ğ¸Ğ¼Ğ°Ñ‚ÑŒ
    // ĞĞµĞ»ÑŒĞ·Ñ ÑĞ¶Ğ¸Ğ¼Ğ°Ñ‚ÑŒ ĞµÑĞ»Ğ¸ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ°:
    // - Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ½Ğ° cgo callback
    // - Ğ”ĞµÑ€Ğ¶Ğ¸Ñ‚ runtime locks
    // - Ğ’ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ _Gsyscall Ñ pinned stack
    if gp.preemptShrink {
        // Ğ¤Ğ»Ğ°Ğ³ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ ĞµÑĞ»Ğ¸ ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ Ğ½ĞµĞ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾
        gp.preemptShrink = false
        return
    }

    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ â€” Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ copystack()
    copystack(gp, newsize)
}
```

### ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ shrinking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Stack Shrinking Timeline                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚, ÑÑ‚ĞµĞº Ğ²Ñ‹Ñ€Ğ¾Ñ Ğ´Ğ¾ 16KB                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚     â”‚ used: 12KB                     â”‚ 16KB                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                             â”‚
â”‚  2. Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ²Ñ‹ÑˆĞ»Ğ° Ğ¸Ğ· Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾Ğ¹ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ¸, used = 2KB                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚     â”‚ used: 2KB â”‚    wasted: 14KB    â”‚ 16KB                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                             â”‚
â”‚  3. GC Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ scanstack() â†’ shrinkstack()                                â”‚
â”‚     used (2KB) < oldsize/4 (4KB) âœ“ â†’ ÑĞ¶Ğ¸Ğ¼Ğ°ĞµĞ¼!                               â”‚
â”‚                                                                             â”‚
â”‚  4. ĞŸĞ¾ÑĞ»Ğµ shrink: ÑÑ‚ĞµĞº = 8KB                                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚     â”‚ used: 2KB â”‚    â”‚ 8KB                                                  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                                                             â”‚
â”‚  5. Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ GC: used (2KB) < 8KB/4 (2KB)? ĞĞµÑ‚ â†’ Ğ½Ğµ ÑĞ¶Ğ¸Ğ¼Ğ°ĞµĞ¼                â”‚
â”‚     (Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹, Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¶Ğ°Ñ‚ÑŒ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ·)                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¡Ğ²ÑĞ·ÑŒ Ñ scanstack()

```go
// runtime/mgcmark.go
func scanstack(gp *g, gcw *gcWork) {
    // 1. Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ĞµĞº Ğ´Ğ»Ñ Ğ½Ğ°Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¶Ğ¸Ğ²Ñ‹Ñ… ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    scanStackData(gp, gcw)

    // 2. ĞŸĞ¾Ğ¿Ñ‹Ñ‚Ğ°Ñ‚ÑŒÑÑ ÑĞ¶Ğ°Ñ‚ÑŒ ÑÑ‚ĞµĞº
    //    Ğ­Ñ‚Ğ¾ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ â€” ÑÑ‚ĞµĞº ÑƒĞ¶Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½,
    //    Ğ²ÑĞµ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹, Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°
    shrinkstack(gp)
}
```

### Ğ’Ñ‹Ğ²Ğ¾Ğ´ GC ÑĞ¾ shrinking

```bash
GODEBUG=gctrace=1 ./app

# Ğ’ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğµ:
# gc 5 @2.150s 1%: 0.013+1.2+0.004 ms clock, 0.052+0.26/1.0/2.8+0.016 ms cpu,
# 4->4->2 MB, 5 MB goal, 4 P

# Ğ•ÑĞ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ GODEBUG=gcshrinkstackoff=1, ÑÑ‚ĞµĞºĞ¸ Ğ½Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑĞ¶Ğ¸Ğ¼Ğ°Ñ‚ÑŒÑÑ
# ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ stack shrinking
```

## Preemption: Cooperative Ğ¸ Asynchronous

### Cooperative Preemption (Ğ´Ğ¾ Go 1.14)

Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ñ‚ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² **safe points**:
- Ğ’Ñ‹Ğ·Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ (stack check â†’ morestack)
- Channel Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸
- runtime.Gosched()

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: tight loop Ğ±ĞµĞ· Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ½Ğµ preempt'Ğ¸Ñ‚ÑÑ:

```go
// Ğ­Ñ‚Ğ° Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° ĞĞ• ĞœĞĞ–Ğ•Ğ¢ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ´Ğ¾ Go 1.14
func tightLoop() {
    for {
        x++  // ĞĞµÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ â†’ Ğ½ĞµÑ‚ safe points
    }
}
```

### Asynchronous Preemption (Go 1.14+)

Go 1.14 Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ» async preemption Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Async Preemption (SIGURG)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Scheduler Ñ€ĞµÑˆĞ°ĞµÑ‚: "ÑÑ‚Ñƒ G Ğ¿Ğ¾Ñ€Ğ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ñ‚ÑŒ"                                    â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  preemptM(mp) â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ½Ğ° M                                       â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â”œâ”€â”€â”€ Unix: tgkill(mp.procid, SIGURG)                                    â”‚
â”‚     â””â”€â”€â”€ Windows: SuspendThread() + GetThreadContext()                      â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  Signal Handler (sigtramp â†’ sighandler â†’ doSigPreempt)                      â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  asyncPreempt()                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  1. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ• Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ñ‹ (Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ callee-saved)             â”‚     â”‚
â”‚     â”‚  2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ñ‚ÑŒ Ğ² ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ                   â”‚     â”‚
â”‚     â”‚     â€¢ ĞĞµ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ runtime                                         â”‚     â”‚
â”‚     â”‚     â€¢ ĞĞµ Ğ² atomic section                                       â”‚     â”‚
â”‚     â”‚     â€¢ Ğ•ÑÑ‚ÑŒ stack map Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ PC                               â”‚     â”‚
â”‚     â”‚  3. Ğ•ÑĞ»Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾:                                                 â”‚     â”‚
â”‚     â”‚     gp.asyncSafePoint = true                                    â”‚     â”‚
â”‚     â”‚     mcall(gopreempt_m)                                          â”‚     â”‚
â”‚     â”‚  4. Ğ•ÑĞ»Ğ¸ Ğ½ĞµĞ»ÑŒĞ·Ñ:                                                â”‚     â”‚
â”‚     â”‚     Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ                               â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ SIGURG?

```go
// SIGURG Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾:
// 1. Ğ ĞµĞ´ĞºĞ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸ (out-of-band data Ğ² TCP)
// 2. ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
// 3. ĞĞµ Ğ¼ĞµÑˆĞ°ĞµÑ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°Ğ¼ (SIGPROF Ğ´Ğ»Ñ pprof)
```

### Preemption-safe vs Preemption-unsafe Ñ‚Ğ¾Ñ‡ĞºĞ¸

```go
// runtime/preempt.go
// Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ° Ğ´Ğ»Ñ preemption ĞµÑĞ»Ğ¸:
// 1. Ğ•ÑÑ‚ÑŒ stack map (compiler Ğ·Ğ½Ğ°ĞµÑ‚ Ğ³Ğ´Ğµ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸)
// 2. ĞĞµ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ write barrier
// 3. ĞĞµ Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼ runtime locks
// 4. ĞĞµ Ğ² middle of atomic operation

func isAsyncSafePoint(gp *g, pc uintptr) bool {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ frame info Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ PC
    f := findfunc(pc)
    if !f.valid() {
        return false
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ğ² runtime
    if f.funcID == funcID_systemstack {
        return false
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ stack map
    if !hasStackMap(f, pc) {
        return false
    }

    return true
}
```

## LockOSThread

`runtime.LockOSThread()` Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñƒ Ğº Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼Ñƒ OS thread.

### ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ

```go
// 1. GUI/OpenGL â€” Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°
func initOpenGL() {
    runtime.LockOSThread()
    // Ğ’ÑĞµ OpenGL Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ
}

// 2. Thread-local storage Ğ² cgo
func useTLS() {
    runtime.LockOSThread()
    defer runtime.UnlockOSThread()

    C.init_thread_local()
    // ...
    C.cleanup_thread_local()
}

// 3. setns/unshare Ğ² Linux (network namespaces)
func enterNamespace(ns *os.File) error {
    runtime.LockOSThread()
    // Ğ’ĞĞ–ĞĞ: Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Unlock ĞµÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!
    // Ğ˜Ğ½Ğ°Ñ‡Ğµ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ğ¾Ğ¿Ğ°ÑÑ‚ÑŒ Ğ² ÑÑ‚Ğ¾Ñ‚ namespace

    return unix.Setns(int(ns.Fd()), unix.CLONE_NEWNET)
}
```

### Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```go
// runtime/proc.go
func LockOSThread() {
    gp := getg()
    gp.m.lockedExt++
    dolockOSThread()
}

func dolockOSThread() {
    gp := getg()
    gp.m.lockedg.set(gp)  // M Ğ¿Ğ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ G
    gp.lockedm.set(gp.m)  // G Ğ¿Ğ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ M
}
```

::: warning ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ Ñ LockOSThread
- Ğ—Ğ°Ğ±Ñ‹Ñ‚Ñ‹Ğ¹ `UnlockOSThread` â†’ thread leak
- M Ğ½Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ² pool Ğ¿Ğ¾ĞºĞ° G Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑÑ
- ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Ğ¸Ñ threads Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
:::

## Goroutine Leaks

### ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ ÑƒÑ‚ĞµÑ‡ĞµĞº

```go
// 1. Ğ—Ğ°Ğ±Ñ‹Ñ‚Ñ‹Ğ¹ receiver
func leak1() {
    ch := make(chan int)
    go func() {
        ch <- 42  // ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ° Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ â€” Ğ½ĞµÑ‚ receiver
    }()
}

// 2. Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ±ĞµĞ· Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°
func leak2(ctx context.Context) {
    go func() {
        for {
            // Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ctx.Done()
            doWork()
        }
    }()
}

// 3. Blocked Ğ½Ğ° mutex/channel ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑÑ
func leak3() {
    var mu sync.Mutex
    mu.Lock()
    go func() {
        mu.Lock()  // ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¶Ğ´Ñ‘Ñ‚
        defer mu.Unlock()
    }()
    // mu.Unlock() Ğ·Ğ°Ğ±Ñ‹Ğ»Ğ¸
}
```

### Ğ”ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ Ñ pprof

```bash
# HTTP endpoint
curl http://localhost:6060/debug/pprof/goroutine?debug=2

# Ğ’ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ
import _ "net/http/pprof"
go http.ListenAndServe(":6060", nil)
```

ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°:
```
goroutine 42 [chan send, 5 minutes]:
main.leak1.func1()
    /app/main.go:15 +0x45
created by main.leak1
    /app/main.go:14 +0x35
```

### Ğ”ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ Ñ goleak

```go
import "go.uber.org/goleak"

func TestMain(m *testing.M) {
    goleak.VerifyTestMain(m)
}

// Ğ˜Ğ»Ğ¸ Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ñ‚ĞµÑÑ‚Ğµ
func TestSomething(t *testing.T) {
    defer goleak.VerifyNone(t)
    // ...
}
```

### ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ

```go
// 1. Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ context
func worker(ctx context.Context, jobs <-chan Job) {
    for {
        select {
        case <-ctx.Done():
            return  // Ğ§Ğ¸ÑÑ‚Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´
        case job := <-jobs:
            process(job)
        }
    }
}

// 2. Buffered channel Ğ´Ğ»Ñ "fire and forget"
func notify(ch chan<- Event, e Event) {
    select {
    case ch <- e:
    default:
        // Drop ĞµÑĞ»Ğ¸ receiver Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²
    }
}

// 3. Done channel pattern
func worker(done <-chan struct{}) {
    for {
        select {
        case <-done:
            return
        default:
            doWork()
        }
    }
}
```

## Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: GODEBUG

### schedtrace: Ğ¢Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°

```bash
# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 1000ms
GODEBUG=schedtrace=1000 ./app

# Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğµ
GODEBUG=schedtrace=1000,scheddetail=1 ./app
```

### Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° schedtrace

```
SCHED 3005ms: gomaxprocs=4 idleprocs=1 threads=6 spinningthreads=1
              needspinning=0 idlethreads=2 runqueue=5 [3 1 0 2]
```

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|----------|----------|
| `SCHED 3005ms` | 3005 | Ğ’Ñ€ĞµĞ¼Ñ Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ² Ğ¼Ğ¸Ğ»Ğ»Ğ¸ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ… |
| `gomaxprocs=4` | 4 | ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ P (Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ¾Ğ²) |
| `idleprocs=1` | 1 | P Ğ±ĞµĞ· Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ (Ğ½ĞµÑ‚ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸) |
| `threads=6` | 6 | ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ OS threads (M) |
| `spinningthreads=1` | 1 | M Ğ² spinning Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ (Ğ¸Ñ‰ÑƒÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ) |
| `needspinning=0` | 0 | ĞÑƒĞ¶Ğ½Ñ‹ Ğ»Ğ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ spinners |
| `idlethreads=2` | 2 | M Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ parking (ÑĞ¿ÑÑ‚) |
| `runqueue=5` | 5 | Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ |
| `[3 1 0 2]` | â€” | Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑÑ… P0, P1, P2, P3 |

### Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸

```bash
# Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ğ¾Ğ´ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹:
SCHED 1000ms: gomaxprocs=8 idleprocs=0 threads=10 spinningthreads=2
              runqueue=0 [12 8 15 10 7 11 9 14]
# âœ… Ğ’ÑĞµ P Ğ·Ğ°Ğ½ÑÑ‚Ñ‹ (idleprocs=0)
# âœ… ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ (8-15 Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½)
# âœ… Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¿ÑƒÑÑ‚Ğ°
# âœ… 2 spinning M Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ

# ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°ÑÑ‚
SCHED 1000ms: gomaxprocs=8 idleprocs=0 threads=10 spinningthreads=0
              runqueue=500 [64 58 71 62 55 68 60 65]
# âš ï¸ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ (55-71)
# âš ï¸ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ (500)
# âš ï¸ ĞĞµÑ‚ spinning threads â€” Ğ²ÑĞµ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹
# Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾Ğ·: CPU-bound Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°, Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ P

# ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
SCHED 1000ms: gomaxprocs=8 idleprocs=7 threads=50 spinningthreads=0
              idlethreads=43 runqueue=0 [1 0 0 0 0 0 0 0]
# âš ï¸ ĞŸĞ¾Ñ‡Ñ‚Ğ¸ Ğ²ÑĞµ P idle (7 Ğ¸Ğ· 8)
# âš ï¸ ĞœĞ½Ğ¾Ğ³Ğ¾ threads (50), Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ idle (43)
# âš ï¸ ĞœĞ°Ğ»Ğ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑÑ…
# Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾Ğ·: Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° I/O Ğ¸Ğ»Ğ¸ mutex
```

### scheddetail: Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´

```bash
GODEBUG=schedtrace=1000,scheddetail=1 ./app

# Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ M Ğ¸ P:
# M0: p=0 curg=1 runq=5 gfreecnt=0
# M1: p=-1 curg=-1 runq=0 gfreecnt=0  (idle)
# P0: runq=5 gfreecnt=32
# P1: runq=3 gfreecnt=28
```

| ĞŸĞ¾Ğ»Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|----------|
| `p=0` | M Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº P0 |
| `p=-1` | M Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº P (idle Ğ¸Ğ»Ğ¸ syscall) |
| `curg=1` | Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° (G ID) |
| `curg=-1` | ĞĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ |
| `runq=5` | Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ |
| `gfreecnt=32` | Ğ—Ğ°ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ñ‘Ñ€Ñ‚Ğ²Ñ‹Ñ… G Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ |

### runtime/trace

```go
import "runtime/trace"

func main() {
    f, _ := os.Create("trace.out")
    defer f.Close()

    trace.Start(f)
    defer trace.Stop()

    // ... your code ...
}
```

```bash
go tool trace trace.out
# ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ web UI Ñ:
# - Goroutine analysis
# - Network blocking profile
# - Synchronization blocking
# - Syscall blocking
```

## ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

### Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ â€” Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾?

| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ | Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ |
|------------|----------|--------------|
| 1-100 | CLI tool | ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ |
| 100-1K | Web server | ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ |
| 1K-10K | High-load server | ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ |
| 10K-100K | Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ | ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒ |
| 100K+ | Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ |

### Memory footprint

```go
// ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ overhead Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹:
// - Stack: 2KB (Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ Ğ´Ğ¾ ~1GB max)
// - runtime.g struct: ~400 bytes
// - Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹: ~100-200 bytes
// Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: ~2.5KB Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ½Ğ° Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñƒ

// 100K Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ â‰ˆ 250MB RAM Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° ÑÑ‚ĞµĞºĞ¸
```

### Worker Pool Pattern

```go
func workerPool(jobs <-chan Job, results chan<- Result, workers int) {
    var wg sync.WaitGroup
    wg.Add(workers)

    for i := 0; i < workers; i++ {
        go func() {
            defer wg.Done()
            for job := range jobs {
                results <- process(job)
            }
        }()
    }

    wg.Wait()
    close(results)
}
```
